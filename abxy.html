<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Gamepad Viewer - Xbox One</title>
    <link rel="stylesheet" href="/mytest/variables.css">
    <link rel="stylesheet" href="../manip_abxy/abxy.css">
</head>
<body>
    <div class="controller xbox">
        <!-- ABXY -->
        <div class="abxy">
            <div class="button a"></div>
            <div class="button b"></div>
            <div class="button x"></div>
            <div class="button y"></div>
        </div>

        <!-- Triggers -->
        <div class="triggers">
            <div class="trigger left"></div>
            <div class="trigger right"></div>
        </div>

        <!-- Bumpers -->
        <div class="bumpers">
            <div class="bumper left"></div>
            <div class="bumper right"></div>
        </div>

        <!-- Quadrant -->
        <div class="quadrant p0"></div>

        <!-- Start & Back -->
        <div class="arrows">
            <div class="back"></div>
            <div class="start"></div>
        </div>

        <!-- Sticks -->
        <div class="sticks">
            <div class="stick left"></div>
            <div class="stick right"></div>
        </div>

        <!-- DPad -->
        <div class="dpad">
            <div class="face up"></div>
            <div class="face down"></div>
            <div class="face left"></div>
            <div class="face right"></div>
        </div>

        <!-- Popup de notification -->
        <div id="gamepad-notification" class="notification">
            <p id="gamepad-status">Aucun gamepad connecté</p>
            <p id="gamepad-info"></p>
        </div>
    </div>

    <script>
        // Récupère l'élément de notification
        const notification = document.getElementById('gamepad-notification');
        const statusElement = document.getElementById('gamepad-status');
        const infoElement = document.getElementById('gamepad-info');
        const controller = document.querySelector('.controller.xbox');

        let prevButtonsState = [];

        const buttonNames = {
            0: "A",
            1: "B",
            2: "X",
            3: "Y",
            4: "LB",
            5: "RB",
            6: "LT",
            7: "RT",
            8: "Back",
            9: "Start",
            10: "Stick gauche",
            11: "Stick droit",
            12: "Haut",
            13: "Bas",
            14: "Gauche",
            15: "Droite"
        };

        // Fonction pour afficher la notification
        function showNotification(message, gamepadInfo = "") {
            statusElement.textContent = message;
            infoElement.textContent = gamepadInfo;

            notification.classList.add('show');

            setTimeout(() => {
                notification.classList.remove('show');
            }, 2000); // popup plus court pour éviter le spam
        }

        // Fonction pour mettre à jour l'état de la manette
        function updateGamepad() {
            const gamepads = navigator.getGamepads();
            const gp = gamepads[0];

            if (!gp) {
                controller.classList.add('disconnected');
                return;
            }

            controller.classList.remove('disconnected');

            // Vérifier chaque bouton
            gp.buttons.forEach((btn, i) => {
                const pressed = btn.pressed;

                // Détection des transitions (pressé / relâché)
                if (pressed && !prevButtonsState[i]) {
                    showNotification(`Bouton ${buttonNames[i] || i} pressé`);
                } else if (!pressed && prevButtonsState[i]) {
                    showNotification(`Bouton ${buttonNames[i] || i} relâché`);
                }

                // Mettre à jour l'état visuel (exemple pour A/B/X/Y)
                if (i === 0) document.querySelector(".button.a").classList.toggle("pressed", pressed);
                if (i === 1) document.querySelector(".button.b").classList.toggle("pressed", pressed);
                if (i === 2) document.querySelector(".button.x").classList.toggle("pressed", pressed);
                if (i === 3) document.querySelector(".button.y").classList.toggle("pressed", pressed);

                // Sauvegarder l’état pour la prochaine frame
                prevButtonsState[i] = pressed;
            });

            requestAnimationFrame(updateGamepad);
        }

        // Écouteurs connexion/déconnexion
        window.addEventListener("gamepadconnected", (e) => {
            const gp = e.gamepad;
            console.log("Gamepad connecté:", gp);
            controller.classList.remove('disconnected');
            showNotification("Gamepad connecté", `ID: ${gp.id}, Boutons: ${gp.buttons.length}, Axes: ${gp.axes.length}`);

            // Init états des boutons
            prevButtonsState = gp.buttons.map(b => b.pressed);
        });

        window.addEventListener("gamepaddisconnected", (e) => {
            const gp = e.gamepad;
            console.log("Gamepad déconnecté:", gp);
            controller.classList.add('disconnected');
            showNotification("Gamepad déconnecté", `ID: ${gp.id}`);
        });

        // Démarre la mise à jour du gamepad
        requestAnimationFrame(updateGamepad);
    </script>
</body>
</html>
